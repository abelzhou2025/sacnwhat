<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR åŠŸèƒ½æµ‹è¯• - ScanWhat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">ğŸ§ª OCR åŠŸèƒ½æµ‹è¯•</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-8">åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æµ‹è¯• OCR åŠŸèƒ½</p>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">ğŸ“¸ ä¸Šä¼ å›¾ç‰‡</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    é€‰æ‹©å›¾ç‰‡æˆ–æ‹ç…§
                </label>
                <input 
                    type="file" 
                    id="imageInput" 
                    accept="image/*" 
                    capture="environment"
                    class="block w-full text-sm text-gray-500 dark:text-gray-400
                           file:mr-4 file:py-2 file:px-4
                           file:rounded-full file:border-0
                           file:text-sm file:font-semibold
                           file:bg-indigo-50 file:text-indigo-700
                           hover:file:bg-indigo-100
                           dark:file:bg-indigo-900 dark:file:text-indigo-300"
                />
            </div>

            <div id="previewContainer" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    å›¾ç‰‡é¢„è§ˆ
                </label>
                <img id="previewImage" src="" alt="Preview" class="max-w-full h-auto rounded-lg shadow-md max-h-64">
            </div>

            <div class="flex gap-4">
                <button 
                    id="testButton" 
                    onclick="testOCR()"
                    class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <span id="buttonText">ğŸš€ å¼€å§‹æµ‹è¯• OCR</span>
                    <span id="loadingSpinner" class="loading hidden"></span>
                </button>
                <button 
                    onclick="clearAll()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white font-bold py-2 px-6 rounded-lg transition-colors"
                >
                    ğŸ—‘ï¸ æ¸…é™¤
                </button>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">âš™ï¸ é…ç½®</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    API ç«¯ç‚¹ (Function URL)
                </label>
                <input 
                    type="text" 
                    id="apiEndpoint" 
                    value="/.netlify/functions/ocr"
                    placeholder="/.netlify/functions/ocr"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg 
                           bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                           focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    æœ¬åœ°å¼€å‘: http://localhost:8888/.netlify/functions/ocr<br>
                    ç”Ÿäº§ç¯å¢ƒ: /.netlify/functions/ocr
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    æµ‹è¯•æ¨¡å¼
                </label>
                <select 
                    id="testMode"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg 
                           bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                           focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                >
                    <option value="local">æœ¬åœ°å¼€å‘ (Netlify Dev)</option>
                    <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
                </select>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            
            <div id="resultContainer" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        æå–çš„æ–‡æœ¬
                    </label>
                    <textarea 
                        id="resultText" 
                        readonly
                        class="w-full h-64 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg 
                               bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white
                               font-mono text-sm resize-none"
                    ></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            å¤„ç†æ—¶é—´
                        </label>
                        <div id="processingTime" class="text-lg font-semibold text-indigo-600 dark:text-indigo-400">
                            -
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            æ–‡æœ¬é•¿åº¦
                        </label>
                        <div id="textLength" class="text-lg font-semibold text-indigo-600 dark:text-indigo-400">
                            -
                        </div>
                    </div>
                </div>

                <button 
                    onclick="copyText()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                >
                    ğŸ“‹ å¤åˆ¶æ–‡æœ¬
                </button>
            </div>

            <div id="errorContainer" class="hidden">
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-300 dark:border-red-500 rounded-lg p-4">
                    <h3 class="text-red-800 dark:text-red-400 font-semibold mb-2">âŒ é”™è¯¯</h3>
                    <pre id="errorText" class="text-red-600 dark:text-red-300 text-sm whitespace-pre-wrap"></pre>
                </div>
            </div>
        </div>

        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-300 dark:border-blue-500 rounded-lg p-4">
            <h3 class="text-blue-800 dark:text-blue-400 font-semibold mb-2">â„¹ï¸ ä½¿ç”¨è¯´æ˜</h3>
            <ul class="text-blue-700 dark:text-blue-300 text-sm space-y-1 list-disc list-inside">
                <li>é€‰æ‹©ä¸€å¼ åŒ…å«æ–‡å­—çš„å›¾ç‰‡</li>
                <li>ç‚¹å‡»"å¼€å§‹æµ‹è¯• OCR"æŒ‰é’®</li>
                <li>ç­‰å¾…å¤„ç†å®Œæˆï¼ŒæŸ¥çœ‹æå–çš„æ–‡æœ¬</li>
                <li>å¦‚æœä½¿ç”¨æœ¬åœ°å¼€å‘ï¼Œç¡®ä¿è¿è¡Œ <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">npm run dev:netlify</code></li>
                <li>æŸ¥çœ‹æµè§ˆå™¨ Console (F12) è·å–è¯¦ç»†æ—¥å¿—</li>
            </ul>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let imageBase64 = null;

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    imageBase64 = dataUrl.split(',')[1]; // ç§»é™¤ data:image/...;base64, å‰ç¼€
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    document.getElementById('previewImage').src = dataUrl;
                    document.getElementById('previewContainer').classList.remove('hidden');
                    
                    // å¯ç”¨æŒ‰é’®
                    document.getElementById('testButton').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        // ç›‘å¬æµ‹è¯•æ¨¡å¼å˜åŒ–
        document.getElementById('testMode').addEventListener('change', function(e) {
            const endpoint = document.getElementById('apiEndpoint');
            if (e.target.value === 'local') {
                endpoint.value = 'http://localhost:8888/.netlify/functions/ocr';
            } else {
                endpoint.value = '/.netlify/functions/ocr';
            }
        });

        // æµ‹è¯• OCR åŠŸèƒ½
        async function testOCR() {
            if (!selectedFile || !imageBase64) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                return;
            }

            const button = document.getElementById('testButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultContainer = document.getElementById('resultContainer');
            const errorContainer = document.getElementById('errorContainer');
            const endpoint = document.getElementById('apiEndpoint').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            buttonText.textContent = 'â³ å¤„ç†ä¸­...';
            loadingSpinner.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');

            const startTime = Date.now();

            try {
                console.log('ğŸš€ å¼€å§‹ OCR æµ‹è¯•');
                console.log('ğŸ“¸ å›¾ç‰‡:', selectedFile.name, selectedFile.size, 'bytes');
                console.log('ğŸ”— ç«¯ç‚¹:', endpoint);
                console.log('ğŸ“ MIME Type:', selectedFile.type);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        base64Image: imageBase64,
                        mimeType: selectedFile.type,
                    }),
                });

                const duration = Date.now() - startTime;

                console.log('â±ï¸ å“åº”æ—¶é—´:', duration, 'ms');
                console.log('ğŸ“Š çŠ¶æ€ç :', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: await response.text() }));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('âœ… æˆåŠŸ!', data);

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('resultText').value = data.text || 'æœªæå–åˆ°æ–‡æœ¬';
                document.getElementById('processingTime').textContent = duration + ' ms';
                document.getElementById('textLength').textContent = (data.text || '').length + ' å­—ç¬¦';
                
                resultContainer.classList.remove('hidden');
                errorContainer.classList.add('hidden');

            } catch (error) {
                console.error('âŒ é”™è¯¯:', error);
                
                // æ˜¾ç¤ºé”™è¯¯
                document.getElementById('errorText').textContent = error.message || 'æœªçŸ¥é”™è¯¯';
                errorContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.disabled = false;
                buttonText.textContent = 'ğŸš€ å¼€å§‹æµ‹è¯• OCR';
                loadingSpinner.classList.add('hidden');
            }
        }

        // å¤åˆ¶æ–‡æœ¬
        function copyText() {
            const text = document.getElementById('resultText').value;
            navigator.clipboard.writeText(text).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²å¤åˆ¶!';
                button.classList.add('bg-green-700');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-700');
                }, 2000);
            });
        }

        // æ¸…é™¤æ‰€æœ‰
        function clearAll() {
            document.getElementById('imageInput').value = '';
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('errorContainer').classList.add('hidden');
            document.getElementById('testButton').disabled = true;
            selectedFile = null;
            imageBase64 = null;
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', function() {
            console.log('ğŸ§ª OCR æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ğŸ“‹ ä½¿ç”¨è¯´æ˜:');
            console.log('  1. é€‰æ‹©ä¸€å¼ åŒ…å«æ–‡å­—çš„å›¾ç‰‡');
            console.log('  2. ç‚¹å‡»"å¼€å§‹æµ‹è¯• OCR"æŒ‰é’®');
            console.log('  3. æŸ¥çœ‹ç»“æœå’Œæ—¥å¿—');
        });
    </script>
</body>
</html>

